<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Wallet · Mobile</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0a0c10; --ink:#e7ecf4; --muted:#9aa7ba; --line:#1b2230; --tile:#0f141c;
    --btn:#1e293b; --btnink:#e7ecf4; --btnline:#2a3a55; --chip:#121925; --chipline:#1b2536;
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:420px;margin:0 auto;padding:16px}
  h1{font-size:22px;margin:0 0 6px}
  .sub{color:var(--muted);font-size:13px}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:12px;overflow:hidden}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600}
  .btn.small{padding:7px 10px;font-weight:600}
  .chip{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--chipline);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;height:26px}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--chipline);background:var(--chip);font-size:12px}
  .ok{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.35)}
  .warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35)}
  .bad{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.35)}
  input{width:100%;background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:12px;padding:10px}
  .kicker{color:var(--muted);font-size:12px;margin-bottom:6px}
  .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .knum{font-size:34px;font-weight:800;letter-spacing:0.5px}
  .note{color:var(--muted);font-size:12px}
  .issuer{font-weight:700;margin-bottom:6px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .metric{border:1px solid var(--line);background:rgba(255,255,255,.01);border-radius:12px;padding:10px}
  .mkey{color:var(--muted);font-size:12px}
  .mval{font-weight:700;margin-top:2px}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .rcpt{border:1px solid var(--line);border-radius:14px;padding:10px}
  .rcpt .h{display:flex;justify-content:space-between;align-items:center}
  .rcpt .subline{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
  .ell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px;display:inline-block}
  .danger{border-color:rgba(220,38,38,.35)}
  .okay{border-color:rgba(22,163,74,.35)}
  .center{display:flex;justify-content:space-between;align-items:center}
  .right{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .tap{font-size:12px;color:var(--muted)}
  .tight{margin-top:8px}
  /* compact mode for issuer cards */
  .issuer-card.compact .grid{grid-template-columns:1fr 1fr}
  .issuer-card.compact .metric{padding:8px}
  .issuer-card.compact .knum{font-size:26px}
</style>
</head>
<body>
<div class="wrap">
  <div class="center">
    <div>
      <h1>OpenLine Wallet</h1>
      <div class="sub">Proof moves; data doesn’t.</div>
    </div>
    <a class="btn small" href="https://github.com/terryncew/openline-wallet" target="_blank">Repo</a>
  </div>

  <!-- OVERALL -->
  <div class="tile" id="overall">
    <div class="kicker" id="windowText">7-day posture</div>
    <div class="row">
      <div class="muted" id="postureLine">—</div>
      <div class="knum" id="overallScore">—</div>
    </div>
    <div class="tight" id="adviceLine" aria-live="polite">—</div>
  </div>

  <!-- ACTIONS -->
  <div class="tile">
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <a class="btn" id="addRand">Add Random</a>
      <a class="btn" id="addRand5">Add ×5</a>
      <a class="btn" id="exportJsonl">Export JSONL</a>
    </div>
    <div class="inline" style="gap:8px;margin-bottom:8px">
      <input id="urlBox" placeholder="Add receipt by URL (raw GitHub best)">
      <a class="btn" id="addUrl">Add</a>
    </div>
    <div class="inline" style="gap:8px">
      <a class="btn" id="clearAll">Clear</a>
      <a class="btn" id="exportPdf">Export PDF</a>
      <a class="btn" id="copySummary">Copy Summary</a>
    </div>
    <div class="note tight">Demo data runs in-memory. Mix real URLs for realism.</div>
  </div>

  <!-- ISSUER HEALTH -->
  <div class="tile">
    <div class="center">
      <div style="font-weight:700">Issuer health</div>
      <div class="tap">tap rows = compact</div>
    </div>
    <div id="issuerCards" class="list"></div>
  </div>

  <!-- RECEIPTS -->
  <div class="tile">
    <div style="font-weight:700;margin-bottom:6px">Receipts</div>
    <div id="receiptList" class="list"></div>
    <div class="center tight">
      <span class="note" id="receiptCount">—</span>
      <a class="btn small" id="toggleDeep">Show deep table</a>
    </div>
    <div id="deepTableWrap" class="tight" style="display:none">
      <div class="note">Nerd mode · horizontal scroll</div>
      <div id="deepTable" class="tight" style="overflow-x:auto;border:1px solid var(--line);border-radius:12px"></div>
    </div>
  </div>

  <div class="sub" style="margin:16px 0">OpenLine · COLE · MIT.</div>
</div>

<script>
/* -------------------- tiny helpers -------------------- */
const $ = sel => document.querySelector(sel);
const el=(t,c,txt)=>{const e=document.createElement(t); if(c) e.className=c; if(txt!=null) e.textContent=txt; return e;};
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const pct = v => (v*100).toFixed(1)+'%';
const round3 = v => (Math.round(v*1000)/1000).toFixed(3);
const nowISO = ()=> new Date().toISOString();

/* -------------------- demo receipt generator -------------------- */
function makeRandomReceipt(){
  const labs = ['labA','labB','opsX','unknown'];
  const models = ['demo-llm','op-llm','agent-x'];
  const bucket = Math.random();
  let badge, kRange, dRange, pRange;
  if (bucket<0.55){ badge='GREEN'; kRange=[0.05,0.50]; dRange=[0.00,0.28]; pRange=[0.75,0.98]; }
  else if (bucket<0.9){ badge='AMBER'; kRange=[0.50,0.90]; dRange=[0.28,0.60]; pRange=[0.45,0.80]; }
  else { badge='RED'; kRange=[0.90,1.20]; dRange=[0.60,1.00]; pRange=[0.10,0.45]; }
  const pick = a => a[Math.floor(Math.random()*a.length)];
  const between=(a,b)=> a + Math.random()*(b-a);
  return {
    rid: crypto.randomUUID(),
    issuer_id: pick(labs),
    model: pick(models),
    issued_at: nowISO(),
    attrs:{status:badge},
    signals:{
      kappa:+between(...kRange).toFixed(3),
      dhol:+between(...dRange).toFixed(3),
      phi_star:+between(...pRange).toFixed(3)
    },
    bytes: 512 + Math.floor(Math.random()*120)
  };
}

/* -------------------- store -------------------- */
let RECEIPTS = [];

function addReceipt(r){ RECEIPTS.push(r); }
function addRandom(n=1){ for(let i=0;i<n;i++) addReceipt(makeRandomReceipt()); renderAll(); }
async function addByUrl(u){
  try{
    const raw = toRaw(u.trim());
    const res = await fetch(raw + (raw.includes('?')?'&':'?') + 'v=' + Date.now(), {cache:'no-store'});
    const txt = await res.text(); const json = JSON.parse(txt);
    json.bytes = new TextEncoder().encode(txt).length;
    json.rid = json.rid || crypto.randomUUID();
    json.issuer_id = json.issuer_id || 'unknown';
    json.attrs = json.attrs || {status: (json.status||'').toUpperCase()};
    json.signals = json.signals || {kappa: json.kappa, dhol: json.dhol, phi_star: json.phi||json.phi_star};
    addReceipt(json); renderAll();
  }catch{ alert('Add failed');}
}
function toRaw(u){
  try{
    const url = new URL(u);
    if (url.hostname==='github.com'){
      const p = url.pathname.split('/').filter(Boolean);
      if (p[2]==='blob') return `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join('/')}`;
    }
    return u;
  }catch{ return u; }
}

/* -------------------- analytics -------------------- */
function computeIssuerStats(items){
  const byIssuer = {};
  for(const r of items){
    const k=r.signals?.kappa, d=r.signals?.dhol, p=r.signals?.phi_star;
    const badge=(r.attrs?.status||'').toUpperCase();
    const id=r.issuer_id||'unknown';
    (byIssuer[id] ||= {id, total:0, green:0, kappas:[], dhols:[], phis:[], last:[]});
    const b = byIssuer[id];
    b.total++; if (badge==='GREEN') b.green++;
    if (Number.isFinite(k)) b.kappas.push(k);
    if (Number.isFinite(d)) b.dhols.push(d);
    if (Number.isFinite(p)) b.phis.push(p);
    b.last.push({t:Date.parse(r.issued_at||nowISO()), d});
  }
  const out=[];
  for (const id in byIssuer){
    const x = byIssuer[id];
    x.greenRate = x.total ? x.green/x.total : 0;
    x.k95 = percentile(x.kappas, 0.95);
    x.phiFloor = x.phis.length? Math.min(...x.phis): 0;
    x.dholTrend = slopeLast(x.last.map(o=>o.d ?? 0));
    x.health = scoreHealth(x.greenRate, x.k95, x.dholTrend, x.phiFloor);
    x.advice = adviceFor(x);
    out.push(x);
  }
  out.sort((a,b)=>b.health-a.health);
  return out;
}
function percentile(arr, q){
  if (!arr.length) return 0;
  const a=[...arr].sort((x,y)=>x-y);
  const i=clamp((a.length-1)*q,0,a.length-1), lo=Math.floor(i), hi=Math.ceil(i);
  return lo===hi? a[lo] : a[lo]+(a[hi]-a[lo])*(i-lo);
}
function slopeLast(arr){
  if (arr.length<4) return 0;
  const n = Math.min(arr.length, 12);
  const xs = Array.from({length:n}, (_,i)=>i);
  const ys = arr.slice(-n);
  const xbar = xs.reduce((a,b)=>a+b,0)/n;
  const ybar = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (xs[i]-xbar)*(ys[i]-ybar); den += (xs[i]-xbar)**2; }
  return den? num/den : 0; // rough trend; positive = rising drift
}
function scoreHealth(green, k95, dTrend, phiFloor){
  const g = clamp(green,0,1);
  const k = clamp(k95,0,1);         // treat ≥1 as 1
  const d = clamp(dTrend,0,1);      // rising drift penalized
  const p = clamp(phiFloor,0,1);
  const s = 100*(0.5*g + 0.2*(1-k) + 0.2*(1-d) + 0.1*p);
  return Math.round(s);
}
function adviceFor(x){
  const msgs=[];
  if (x.k95>=0.95) msgs.push('Brake: κ high → tighten guardrails or roll back config.');
  if (x.phiFloor<0.20) msgs.push('Raise coherence floor: add test prompts / sampling controls.');
  if (x.dholTrend>=0.15) msgs.push('Watch drift: Δhol rising → investigate data/agent changes.');
  if (x.greenRate<0.60) msgs.push('Lift green rate: simplify chain or reduce variability.');
  if (!msgs.length) msgs.push('Stable: hold config; sample controls weekly.');
  return msgs.join(' ');
}
function overallFrom(stats){
  if (!stats.length) return {score:0, txt:'—'};
  const w = s => s.total; // weight by volume
  const sumW = stats.reduce((a,b)=>a+w(b),0);
  const score = Math.round(stats.reduce((a,s)=>a + s.health*w(s),0)/sumW);
  const green = (stats.reduce((a,s)=>a + s.green,0) / stats.reduce((a,s)=>a + s.total,0)) || 0;
  const txt = `${(green*100).toFixed(1)}% green • ${stats.reduce((a,s)=>a+s.total,0)} receipts`;
  const worst = [...stats].sort((a,b)=>a.health-b.health)[0];
  return {score, txt, worstAdvice: worst? adviceFor(worst): '—'};
}

/* -------------------- render -------------------- */
function chip(txt,cls=''){ const s=el('span','pill '+cls,txt); return s; }

function renderIssuerCards(stats){
  const box = $('#issuerCards'); box.innerHTML='';
  stats.forEach(s=>{
    const card = el('div','rcpt issuer-card');
    const head = el('div','center');
    head.appendChild(el('div','issuer', s.id));
    head.appendChild(el('div','knum', String(s.health)));
    card.appendChild(head);

    const grid = el('div','grid');
    grid.appendChild(metric('Green', pct(s.greenRate)));
    grid.appendChild(metric('κ p95', round3(s.k95)));
    grid.appendChild(metric('Δhol trend', (s.dholTrend>=0?'+':'')+round3(s.dholTrend)));
    grid.appendChild(metric('Φ* floor', round3(s.phiFloor)));
    card.appendChild(grid);

    const advice = el('div','note tight', s.advice);
    card.appendChild(advice);

    card.addEventListener('click', ()=> card.classList.toggle('compact'));
    box.appendChild(card);
  });
}
function metric(k,v){
  const m = el('div','metric');
  m.appendChild(el('div','mkey',k));
  m.appendChild(el('div','mval',v));
  return m;
}

function renderReceipts(list){
  const box = $('#receiptList'); box.innerHTML='';
  const recent = [...list].slice(-25).reverse();
  recent.forEach(r=>{
    const tile = el('div','rcpt ' + (r.attrs?.status==='RED'?'danger':r.attrs?.status==='GREEN'?'okay':''));
    const h = el('div','h');
    h.appendChild(el('div','ell', (r.issued_at||'—').replace('T',' ').replace('Z','')));
    const pills = el('div','right');
    pills.appendChild(chip(r.issuer_id));
    pills.appendChild(chip(r.model));
    const badge = (r.attrs?.status||'—').toUpperCase();
    pills.appendChild(chip(badge, badge==='GREEN'?'ok':badge==='AMBER'?'warn':'bad'));
    h.appendChild(pills);
    tile.appendChild(h);

    const sub = el('div','subline');
    sub.appendChild(chip('κ '+round3(r.signals?.kappa ?? 0)));
    sub.appendChild(chip('Δhol '+round3(r.signals?.dhol ?? 0)));
    sub.appendChild(chip('Φ* '+round3(r.signals?.phi_star ?? 0)));
    sub.appendChild(chip((r.bytes||0)+'B'));
    tile.appendChild(sub);
    box.appendChild(tile);
  });
  $('#receiptCount').textContent = `${list.length} total • showing ${Math.min(25,list.length)}`;
}

function renderDeepTable(list){
  const wrap = $('#deepTable'); wrap.innerHTML='';
  const tbl = document.createElement('table');
  tbl.style.width='660px'; tbl.style.borderCollapse='collapse'; tbl.style.fontSize='13px';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr>
    <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">When</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Issuer</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Model</th>
    <th style="text-align:left;padding:8px;border-bottom:1px solid var(--line)">Badge</th>
    <th style="text-align:right;padding:8px;border-bottom:1px solid var(--line)">κ</th>
    <th style="text-align:right;padding:8px;border-bottom:1px solid var(--line)">Δhol</th>
    <th style="text-align:right;padding:8px;border-bottom:1px solid var(--line)">Φ*</th>
    <th style="text-align:right;padding:8px;border-bottom:1px solid var(--line)">bytes</th>
  </tr>`;
  tbl.appendChild(thead);
  const tb = document.createElement('tbody');
  list.slice(-200).reverse().forEach(r=>{
    const tr=document.createElement('tr');
    const td=(t,align='left')=>{const d=document.createElement('td'); d.style.padding='8px'; d.style.borderBottom='1px solid var(--line)'; d.style.textAlign=align; d.textContent=t; return d;};
    tr.appendChild(td((r.issued_at||'—').replace('T',' ').replace('Z','')));
    tr.appendChild(td(r.issuer_id||'unknown'));
    tr.appendChild(td(r.model||'—'));
    tr.appendChild(td((r.attrs?.status||'—').toUpperCase()));
    tr.appendChild(td(round3(r.signals?.kappa ?? 0),'right'));
    tr.appendChild(td(round3(r.signals?.dhol ?? 0),'right'));
    tr.appendChild(td(round3(r.signals?.phi_star ?? 0),'right'));
    tr.appendChild(td(String(r.bytes||0),'right'));
    tb.appendChild(tr);
  });
  tbl.appendChild(tb); wrap.appendChild(tbl);
}

/* -------------------- top render -------------------- */
function renderAll(){
  const stats = computeIssuerStats(RECEIPTS);
  const ov = overallFrom(stats);
  $('#postureLine').textContent = ov.txt;
  $('#overallScore').textContent = String(ov.score);
  $('#adviceLine').textContent = ov.worstAdvice;
  renderIssuerCards(stats);
  renderReceipts(RECEIPTS);
}

/* -------------------- export / summary -------------------- */
function asJsonl(arr){
  return arr.map(o=>JSON.stringify(o)).join('\n');
}
function download(name, text, type='application/octet-stream'){
  const blob = new Blob([text], {type}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove();},0);
}
function clipboard(text){ navigator.clipboard.writeText(text); }

async function exportPdf(){
  // lazy-load pdf-lib only when needed
  if (!window.PDFLib){
    await new Promise((res,rej)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js';
      s.onload=res; s.onerror=rej; document.head.appendChild(s);
    });
  }
  const { PDFDocument, StandardFonts, rgb } = window.PDFLib;
  const pdfDoc = await PDFDocument.create();
  const page = pdfDoc.addPage([612, 792]); // US Letter
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const bold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const stats = computeIssuerStats(RECEIPTS);
  const ov = overallFrom(stats);
  let y = 760;
  page.drawText('OpenLine Wallet — Compliance Summary', {x:40,y, size:16, font:bold}); y-=22;
  page.drawText(new Date().toISOString(), {x:40,y, size:10, font});
  y-=24;
  page.drawText(`Overall health: ${ov.score}`, {x:40,y, size:14, font:bold}); y-=18;
  page.drawText(`Posture: ${ov.txt}`, {x:40,y, size:12, font}); y-=16;
  page.drawText(`Advice: ${ov.worstAdvice}`, {x:40,y, size:12, font}); y-=24;

  page.drawText('Issuer health (7 days)', {x:40,y, size:12, font:bold}); y-=16;
  stats.slice(0,10).forEach(s=>{
    page.drawText(`${s.id.padEnd(10)}  Health ${String(s.health).padStart(3)}  Green ${pct(s.greenRate)}  κ95 ${round3(s.k95)}  ΔholTrend ${(s.dholTrend>=0?'+':'')+round3(s.dholTrend)}  Φ*floor ${round3(s.phiFloor)}`, {x:40,y, size:10, font});
    y-=14;
  });
  y-=10;
  page.drawText('Top 20 receipts (most recent)', {x:40,y, size:12, font:bold}); y-=16;
  RECEIPTS.slice(-20).reverse().forEach(r=>{
    const line = `${(r.issued_at||'—').replace('T',' ').replace('Z','')}  ${r.issuer_id||'unk'}  ${r.model||'—'}  ${(r.attrs?.status||'—').toUpperCase()}  κ ${round3(r.signals?.kappa||0)}  Δ ${round3(r.signals?.dhol||0)}  Φ* ${round3(r.signals?.phi_star||0)}`;
    page.drawText(line, {x:40,y, size:9, font});
    y-=12;
  });

  const pdfBytes = await pdfDoc.save();
  download(`openline-wallet-${Date.now()}.pdf`, pdfBytes, 'application/pdf');
}

/* -------------------- events -------------------- */
$('#addRand').addEventListener('click', ()=> addRandom(1));
$('#addRand5').addEventListener('click', ()=> addRandom(5));
$('#addUrl').addEventListener('click', ()=> {
  const u=$('#urlBox').value.trim(); if(!u) return;
  addByUrl(u); $('#urlBox').value='';
});
$('#clearAll').addEventListener('click', ()=>{ if(!confirm('Clear all receipts?')) return; RECEIPTS=[]; renderAll(); });
$('#exportJsonl').addEventListener('click', ()=> download(`receipts-${Date.now()}.jsonl`, asJsonl(RECEIPTS), 'application/jsonl'));
$('#copySummary').addEventListener('click', ()=>{
  const stats = computeIssuerStats(RECEIPTS);
  const ov = overallFrom(stats);
  const lines = [
    `OpenLine Wallet — 7-day summary`,
    `Overall health: ${ov.score} (${ov.txt})`,
    `Advice: ${ov.worstAdvice}`,
    `Issuers:`,
    ...stats.map(s=>`  ${s.id}: health ${s.health}, green ${pct(s.greenRate)}, κ95 ${round3(s.k95)}, ΔholTrend ${(s.dholTrend>=0?'+':'')+round3(s.dholTrend)}, Φ*floor ${round3(s.phiFloor)}`)
  ];
  clipboard(lines.join('\n')); alert('Summary copied.');
});
$('#exportPdf').addEventListener('click', exportPdf);
$('#toggleDeep').addEventListener('click', ()=>{
  const w = $('#deepTableWrap');
  const show = w.style.display==='none';
  w.style.display = show?'block':'none';
  if (show) renderDeepTable(RECEIPTS);
});
/* drag-drop ingest */
document.addEventListener('dragover', e=>{e.preventDefault();});
document.addEventListener('drop', async e=>{
  e.preventDefault();
  const f = e.dataTransfer?.files?.[0]; if(!f) return;
  const txt = await f.text(); const json = JSON.parse(txt);
  json.bytes = new TextEncoder().encode(txt).length;
  json.rid = json.rid || crypto.randomUUID();
  json.issuer_id = json.issuer_id || 'unknown';
  json.attrs = json.attrs || {status: (json.status||'').toUpperCase()};
  json.signals = json.signals || {kappa: json.kappa, dhol: json.dhol, phi_star: json.phi||json.phi_star};
  addReceipt(json); renderAll();
});

/* seed & show */
(function boot(){
  const q = new URLSearchParams(location.search);
  if (q.get('u')) addByUrl(q.get('u'));
  addRandom(12);
  $('#windowText').textContent = '7-day posture';
})();
</script>
</body>
</html>
