<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Wallet · Portable Proof</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{--bg:#0a0c10;--ink:#e7ecf4;--muted:#97a3b6;--line:#1b2230;--tile:#0f141c;--btn:#1e293b;--btnink:#e7ecf4;--btnline:#2a3a55;--chip:#121925;--chipline:#1b2536}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  header h1{font-size:20px;margin:2px 0 0}
  .sub{color:var(--muted);font-size:13px}
  .section{margin:18px 0}
  h2{font-size:16px;margin:0 0 8px}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:12px;padding:12px}
  .tile + .tile{margin-top:12px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600;cursor:pointer}
  .chip{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--chipline);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;height:26px}
  .ok{background:rgba(30,166,114,.15);border-color:rgba(30,166,114,.35)}
  .warn{background:rgba(179,139,16,.15);border-color:rgba(179,139,16,.35)}
  .bad{background:rgba(210,61,61,.15);border-color:rgba(210,61,61,.35)}
  .neutral{opacity:.85}
  .note{color:var(--muted);font-size:12px;margin:8px 2px}
  input,textarea{width:100%;background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
  textarea{min-height:110px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 10px;border-top:1px solid var(--line);text-align:left;font-size:13px}
  th{color:var(--muted);font-weight:600}
  .right{text-align:right}
  @media (max-width:560px){ .hide-sm{display:none} }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <h1>OpenLine Wallet</h1>
      <div class="sub">Verify · Store · Explain — all local</div>
    </div>
    <div class="inline">
      <a class="btn" id="btnInstall" role="button">Install</a>
      <a class="btn" id="btnOffline" role="button">Offline ready?</a>
    </div>
  </header>

  <div class="tile">
    <div class="inline">
      <input id="urlInput" placeholder="Add receipt by URL (raw GitHub best)">
      <button class="btn" id="btnAddUrl" type="button">Add URL</button>
      <button class="btn" id="btnSeed"   type="button">Seed from manifest</button>
      <button class="btn" id="btnRand1"  type="button">Add Random</button>
      <button class="btn" id="btnRand5"  type="button">Add 5 Random</button>
    </div>
    <div class="note">Tip: <code>?u=&lt;url&gt;</code> auto-imports on open. Drag a JSON file anywhere on this page to ingest.</div>
    <div style="margin-top:10px">
      <textarea id="jsonBox" placeholder="Or paste one receipt JSON here…"></textarea>
      <div class="inline" style="margin-top:8px">
        <button class="btn" id="btnAddJson" type="button">Add JSON (from box)</button>
        <button class="btn" id="btnExport"  type="button">Export JSONL</button>
        <button class="btn" id="btnClear"   type="button">Clear all</button>
        <button class="btn" id="btnVerify"  type="button">Enable Ed25519 verify (beta)</button>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>Issuer health</h2>
    <div class="note">Score = 100×(0.5·green + 0.2·(1−κ_p95) + 0.2·(1−Δhol_trend) + 0.1·Φ* floor). Window: last 7 days.</div>
    <div class="tile">
      <table id="healthTable">
        <thead>
          <tr>
            <th>Issuer</th><th class="hide-sm">Window</th><th class="right">Health</th><th class="right">Green</th><th class="right">κ p95</th><th class="right">Δhol trend</th><th class="right">Φ* floor</th>
          </tr>
        </thead>
        <tbody id="healthBody"><tr><td colspan="7" class="note">No data yet.</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h2>Receipts</h2>
    <div class="tile" id="receiptsBox">
      <table>
        <thead>
          <tr>
            <th>When</th><th>Issuer</th><th>Model</th><th>Badge</th>
            <th class="right">κ</th><th class="right">Δhol</th><th class="right">Φ*</th><th class="hide-sm right">Bytes</th>
          </tr>
        </thead>
        <tbody id="receiptsBody"><tr><td colspan="8" class="note">Add or seed to begin.</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="section"><div class="sub">All data stays on-device (IndexedDB). No servers. Works offline after first load.</div></div>
</div>

<script>
/* ============ tiny helpers ============ */
const $ = sel => document.querySelector(sel);
const toRaw = (u)=>{ try{ const url=new URL(u.trim()); if(url.hostname==='github.com'){ const p=url.pathname.split('/').filter(Boolean); if(p[2]==='blob') return `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join('/')}`;} return u;}catch{ return u; } };
const clamp01 = v => Math.max(0,Math.min(1,v));
const byteLen = s => new TextEncoder().encode(s).length;
const todayISO = ()=> new Date().toISOString();

/* ============ storage (IndexedDB via minimal wrapper) ============ */
let db;
function idb_open(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open('ol.wallet.v1',1);
    r.onupgradeneeded = () => {
      const d = r.result;
      const t = d.createObjectStore('receipts',{keyPath:'rid'});
      t.createIndex('by_issued','issued_at');
      t.createIndex('by_issuer','issuer_id');
    };
    r.onsuccess = ()=>{ db=r.result; res(); };
    r.onerror = ()=> rej(r.error);
  });
}
function idb_put(store, obj){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite'); tx.onerror=()=>rej(tx.error);
    tx.objectStore(store).put(obj); tx.oncomplete=()=>res();
  });
}
function idb_get_all(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly'); tx.onerror=()=>rej(tx.error);
    const req = tx.objectStore(store).getAll(); req.onsuccess=()=>res(req.result);
  });
}
function idb_clear(store){
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite'); tx.onerror=()=>rej(tx.error);
    tx.objectStore(store).clear(); tx.oncomplete=()=>res();
  });
}

/* ============ normalization ============ */
function normalize(r){
  const rid   = r.rid || r.id || crypto.randomUUID();
  const issuer= r.issuer_id || r.issuer || r.signer || 'unknown';
  const model = r.model?.family || r.model?.name || r.model?.id || r.model || '—';
  const issued= r.issued_at || r.issued || r.run?.ts || r.time || r.date || todayISO();
  const status= (r.attrs?.status || r.status || '').toString().toUpperCase() || 'CLEAN';
  const kappa = num(r.signals?.kappa ?? r.kappa ?? r.κ ?? r.dials?.kappa);
  const dhol  = num(r.signals?.dhol  ?? r.signals?.delta_hol ?? r.delta_hol ?? r.Δhol ?? r.dials?.delta_hol);
  const phi   = num(r.signals?.phi_star ?? r.phi_star ?? r.dials?.phi_star);
  const bytes = r.bytes ?? byteLen(JSON.stringify(r));
  const ctr   = +r.ctr || 0;
  const prev  = r.prev || null;
  return {rid,issuer_id:issuer,model,issued_at:issued,badge:badge(status),kappa,dhol,phi,bytes,ctr,prev,raw:r};
}
function num(v){ const n = Number(v); return Number.isFinite(n)? n : null; }
function badge(s){ if(/RED|RISK|BAD/i.test(s))return 'red'; if(/AMBER|WARN|CHECK/i.test(s))return 'amber'; return 'green'; }

/* ============ rendering ============ */
function renderReceipts(rows){
  const body = $('#receiptsBody');
  if (!rows.length){ body.innerHTML = `<tr><td colspan="8" class="note">Add or seed to begin.</td></tr>`; return; }
  body.innerHTML = rows.slice().sort((a,b)=> (a.issued_at<b.issued_at?1:-1)).map(r=>`
    <tr>
      <td>${r.issued_at.replace('T',' ').replace('Z','')}</td>
      <td>${r.issuer_id}</td>
      <td>${r.model}</td>
      <td><span class="chip ${r.badge==='green'?'ok':r.badge==='amber'?'warn':'bad'}">${r.badge.toUpperCase()}</span></td>
      <td class="right">${fmt(r.kappa)}</td>
      <td class="right">${fmt(r.dhol)}</td>
      <td class="right">${fmt(r.phi)}</td>
      <td class="right hide-sm">${r.bytes}</td>
    </tr>
  `).join('');
}
function fmt(v){ return (v==null)?'—':Number(v).toFixed(3); }

function renderHealth(rows){
  const since = new Date(Date.now()-7*24*3600*1000);
  const byIssuer = new Map();
  rows.forEach(r=>{
    const t = new Date(r.issued_at);
    if (isNaN(t)) return;
    if (t < since) return;
    const list = byIssuer.get(r.issuer_id) || [];
    list.push(r); byIssuer.set(r.issuer_id, list);
  });
  const out = [];
  for (const [issuer, list] of byIssuer){
    const greens = list.filter(x=>x.badge==='green').length;
    const greenRate = list.length? greens/list.length : 0;
    const kP95 = percentile(list.map(x=>x.kappa).filter(isFinite), 0.95) ?? 1.0;
    const dDaily = avg(list.filter(x=>xIsToday(x.issued_at)).map(x=>x.dhol).filter(isFinite));
    const d7     = avg(list.map(x=>x.dhol).filter(isFinite));
    const dTrend = clamp01(Math.max(0, (dDaily - d7)) / (d7||1e-9)); // up is bad
    const phiFloor = Math.min(...list.map(x=>x.phi).filter(isFinite));
    const health = Math.round(100*(0.5*greenRate + 0.2*(1-kP95) + 0.2*(1-dTrend) + 0.1*(isFinite(phiFloor)?phiFloor:0)));
    out.push({issuer,window:`${list.length} rec / 7d`,health,greenRate,kP95,dTrend,phiFloor});
  }
  out.sort((a,b)=> b.health - a.health);
  const body = $('#healthBody');
  if (!out.length){ body.innerHTML = `<tr><td colspan="7" class="note">No data yet.</td></tr>`; return; }
  body.innerHTML = out.map(x=>`
    <tr>
      <td>${x.issuer}</td><td class="hide-sm">${x.window}</td>
      <td class="right"><b>${x.health}</b></td>
      <td class="right">${(x.greenRate*100).toFixed(1)}%</td>
      <td class="right">${x.kP95.toFixed(3)}</td>
      <td class="right">${x.dTrend.toFixed(3)}</td>
      <td class="right">${isFinite(x.phiFloor)?x.phiFloor.toFixed(3):'—'}</td>
    </tr>
  `).join('');
}
function avg(a){ return a.length? a.reduce((s,v)=>s+v,0)/a.length : 0; }
function percentile(arr,p){
  if (!arr.length) return null;
  const a = arr.slice().sort((x,y)=>x-y);
  const i = Math.min(a.length-1, Math.max(0, Math.floor(p*(a.length-1))));
  return a[i];
}
function xIsToday(iso){
  const d = new Date(iso), n = new Date();
  return d.getUTCFullYear()===n.getUTCFullYear() && d.getUTCMonth()===n.getUTCMonth() && d.getUTCDate()===n.getUTCDate();
}

/* ============ importers ============ */
async function addUrl(u){
  const raw = toRaw(u);
  const res = await fetch(raw, {cache:'no-store'});
  if(!res.ok) throw new Error(`fetch ${res.status}`);
  const txt = await res.text();
  const obj = JSON.parse(txt);
  await addReceipt(obj);
}
async function addReceipt(obj){
  const n = normalize(obj);
  await idb_put('receipts', n);
  await refresh();
}
async function addRandom(n=1){
  for (let i=0;i<n;i++){ await addReceipt(makeRandomReceipt()); }
}
function makeRandomReceipt(){
  const bucket=Math.random();
  let badge='green', k=[0.05,0.5], d=[0.00,0.30], p=[0.80,0.98];
  if (bucket>0.6 && bucket<=0.9){ badge='amber'; k=[0.50,0.90]; d=[0.30,0.60]; p=[0.45,0.80]; }
  if (bucket>0.9){ badge='red'; k=[0.90,1.20]; d=[0.60,1.00]; p=[0.10,0.45]; }
  const rnd=(a,b)=> +(a + Math.random()*(b-a)).toFixed(3);
  return {
    receipt_version:"1.5-P",
    issued_at: todayISO(),
    issuer_id: ['labA','labB','opsX'][Math.floor(Math.random()*3)],
    model:{family:['demo-llm','op-llm','agent-x'][Math.floor(Math.random()*3)]},
    attrs:{status: badge.toUpperCase()},
    precision:{train_dtype:"fp16",infer_dtype:"fp16"},
    signals:{kappa:rnd(...k), dhol:rnd(...d), phi_star:rnd(...p)}
  };
}
async function seedFromManifest(){
  try{
    const res = await fetch('receipts/manifest.json?ts='+Date.now(), {cache:'no-store'});
    if (!res.ok) throw new Error('manifest 404');
    const list = await res.json();
    const urls = Array.isArray(list)? list : (list.files||list.receipts||list.items||[]);
    if(!urls || !urls.length) throw new Error('manifest empty');
    for (const u of urls){ try{ await addUrl(u); }catch(e){} }
  }catch(e){
    alert('Seed failed: ' + e.message);
  }
}

/* ============ UI wiring ============ */
async function refresh(){
  const rows = await idb_get_all('receipts');
  renderReceipts(rows);
  renderHealth(rows);
}
let verifyOn = false;
function wireUI(){
  $('#btnAddUrl').addEventListener('click', async (e)=>{ e.preventDefault(); const u=$('#urlInput').value.trim(); if(!u) return; try{ await addUrl(u); $('#urlInput').value=''; }catch(err){ alert('Add URL failed'); } });
  $('#btnAddJson').addEventListener('click', async (e)=>{ e.preventDefault(); const t=$('#jsonBox').value.trim(); if(!t) return; try{ const obj=JSON.parse(t); await addReceipt(obj); $('#jsonBox').value=''; }catch(err){ alert('JSON parse failed'); } });
  $('#btnSeed').addEventListener('click', async (e)=>{ e.preventDefault(); await seedFromManifest(); });
  $('#btnRand1').addEventListener('click', async (e)=>{ e.preventDefault(); await addRandom(1); });
  $('#btnRand5').addEventListener('click', async (e)=>{ e.preventDefault(); await addRandom(5); });
  $('#btnExport').addEventListener('click', async (e)=>{ e.preventDefault(); const rows=await idb_get_all('receipts'); const blob=new Blob(rows.map(r=>JSON.stringify(r.raw)+'\n'),{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='receipts.jsonl'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); });
  $('#btnClear').addEventListener('click', async (e)=>{ e.preventDefault(); if(!confirm('Clear all receipts?'))return; await idb_clear('receipts'); await refresh(); });
  $('#btnVerify').addEventListener('click', (e)=>{ e.preventDefault(); verifyOn=!verifyOn; alert(verifyOn?'(beta) Signature checks ON (stub)':'Signature checks OFF'); });
  // PWA affordances
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; });
  $('#btnInstall').addEventListener('click', async (e)=>{ e.preventDefault(); if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; } else { alert('Use “Add to Home Screen”'); } });
  $('#btnOffline').addEventListener('click', (e)=>{ e.preventDefault(); alert(navigator.onLine?'Online (will work offline after first load)':'Offline ✔'); });

  // Drag & drop JSON file support
  document.addEventListener('dragover', e=>{ e.preventDefault(); });
  document.addEventListener('drop', async e=>{
    e.preventDefault();
    const f = e.dataTransfer?.files?.[0]; if(!f) return;
    const txt = await f.text(); try{ const obj=JSON.parse(txt); await addReceipt(obj); }catch{ alert('Dropped file is not valid JSON'); }
  });

  // URL auto-import
  const u = new URL(location.href).searchParams.get('u');
  if (u) addUrl(u).catch(()=>{});
}

/* ============ boot ============ */
(async function(){
  await idb_open();
  wireUI();
  await refresh();
  // Service worker (optional if you already have sw.js)
  if ('serviceWorker' in navigator) {
    try{ await navigator.serviceWorker.register('./sw.js'); }catch{}
  }
})();
</script>
</body>
</html>
