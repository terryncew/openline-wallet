<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Wallet</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0a0c10; --ink:#e7ecf4; --muted:#97a3b6;
    --line:#1b2230; --tile:#0f141c;
    --btn:#182234; --btnink:#e7ecf4; --btnline:#2a3a55;
    --ok:#1ea672; --warn:#b38b10; --bad:#d23d3d;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px;padding-bottom:calc(18px + env(safe-area-inset-bottom,0))}
  header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  header h1{font-size:20px;margin:2px 0 0}
  .sub{color:var(--muted);font-size:13px}
  .section{margin:18px 0}
  h2{font-size:16px;margin:0 0 8px}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:12px;padding:12px;overflow:hidden}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px}
  .chip{display:inline-block;min-width:64px;text-align:center;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid var(--line)}
  .chip.ok{background:rgba(30,166,114,.15);border-color:rgba(30,166,114,.35)}
  .chip.warn{background:rgba(179,139,16,.15);border-color:rgba(179,139,16,.35)}
  .chip.bad{background:rgba(210,61,61,.15);border-color:rgba(210,61,61,.35)}
  .note{color:var(--muted);font-size:12px;margin:8px 2px}

  /* Table discipline */
  .table-wrap{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .table-scroller{overflow:auto;-webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;min-width:560px}
  th,td{padding:12px 14px;border-top:1px solid var(--line)}
  thead th{position:sticky;top:0;background:var(--tile);z-index:1;border-top:0}
  tbody tr:first-child td{border-top:0}
  th{font-weight:600;color:var(--muted);text-align:left}
  td.num,th.num{font-variant-numeric:tabular-nums;text-align:right}
  .ellipsis{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Cards fallback for narrow screens */
  @media (max-width:520px){
    table{min-width:480px}
  }

  /* Badges inside cells */
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .badge.ok{background:rgba(30,166,114,.15)}
  .badge.warn{background:rgba(179,139,16,.15)}
  .badge.bad{background:rgba(210,61,61,.15)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>OpenLine Wallet</h1>
      <div class="sub">Portable proof Â· vendor-neutral Â· iPhone-friendly</div>
    </div>
    <div class="inline">
      <a class="btn" href="https://terryncew.github.io/openline-hub/">Back to Hub</a>
      <a class="btn" href="#wallet">Jump to Wallet</a>
    </div>
  </header>

  <div class="section tile">
    <div style="font-size:18px;font-weight:700;margin-bottom:6px">Insights</div>
    <div id="insights" class="sub">Load or simulate receipts to get triage calls.</div>
    <div class="note">Heuristics: Brake if Îº p95 â‰¥ 0.95 or Î¦* floor &lt; 0.15. Watch if Î”hol trend â†‘ â‰¥ 0.15 or green &lt; 60%. Go if green â‰¥ 85% and Îº p95 &lt; 0.6.</div>
  </div>

  <div class="section tile" id="controls">
    <div class="inline" style="gap:8px;margin-bottom:10px">
      <a class="btn" id="addRand5">Add 5 Random</a>
      <a class="btn" id="addRand">Add 1 Random</a>
      <a class="btn" id="clearAll">Clear all</a>
      <a class="btn" id="exportJsonl">Export JSONL</a>
    </div>
    <div class="note" id="packStats">â€”</div>
  </div>

  <div class="section">
    <h2>Issuer health</h2>
    <div class="note">Score = 100Ã—(0.5Â·green + 0.2Â·(1âˆ’Îº_p95) + 0.2Â·(1âˆ’Î”hol_trend) + 0.1Â·Î¦* floor). Window: last 7 days.</div>
    <div class="table-wrap">
      <div class="table-scroller">
        <table id="issuerTbl">
          <thead>
            <tr>
              <th class="ellipsis">Issuer</th>
              <th class="num">Health</th>
              <th class="num">Green</th>
              <th class="num">Îº p95</th>
              <th class="num">Î”hol trend</th>
              <th class="num">Î¦* floor</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 id="wallet">Receipts</h2>
    <div class="table-wrap">
      <div class="table-scroller">
        <table id="rcpTbl">
          <thead>
            <tr>
              <th class="ellipsis">When</th>
              <th class="ellipsis">Issuer</th>
              <th class="ellipsis">Model</th>
              <th class="ellipsis">Badge</th>
              <th class="num">Îº</th>
              <th class="num">Î”hol</th>
              <th class="num">Î¦*</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="section sub">OpenLine Â· COLE Â· MIT.</div>
</div>

<script>
/* ------------------- helpers ------------------- */
const clamp01 = v => Math.max(0, Math.min(1, v));
const avg = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
const p95 = a => {
  if(!a.length) return 0;
  const s = [...a].sort((x,y)=>x-y);
  const i = Math.min(s.length-1, Math.floor(0.95*(s.length-1)));
  return s[i];
};
const trend = vals => { // simple slope vs index in [0..n)
  const n = vals.length; if(n<2) return 0;
  const mx = avg(vals), mt = (n-1)/2;
  let num=0, den=0;
  for(let t=0;t<n;t++){ const y=vals[t]; num += (t-mt)*(y-mx); den += (t-mt)*(t-mt); }
  return den? num/den : 0;
};
const asBadge = s => s.match(/green|ok|clean/i)?'ok':s.match(/amber|warn|check/i)?'warn':'bad';
const fmtPct = x => (x*100).toFixed(1)+'%';
const fmt3 = x => Number.isFinite(x)? x.toFixed(3) : '0.000';

/* ------------------- demo data ------------------- */
let RECEIPTS = []; // append-only

function makeRandomReceipt(){
  const now = new Date().toISOString();
  const issuer = pick(['labA','labB','opsX']);
  const model  = pick(['agent-x','op-llm','demo-llm']);
  const bucket = Math.random();
  let badge, kRange, dRange, pRange;
  if (bucket < 0.65){ badge='GREEN'; kRange=[0.05,0.55]; dRange=[0.00,0.30]; pRange=[0.80,0.98]; }
  else if (bucket < 0.9){ badge='AMBER'; kRange=[0.55,0.90]; dRange=[0.30,0.60]; pRange=[0.45,0.80]; }
  else { badge='RED'; kRange=[0.90,1.20]; dRange=[0.60,1.00]; pRange=[0.10,0.45]; }
  return {
    rid: cryptoRandomId(),
    issued_at: now, issuer, model, bytes: 512,
    attrs:{status:badge},
    signals:{kappa:randBetween(...kRange), dhol:randBetween(...dRange), phi_star:randBetween(...pRange)}
  };
}
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function randBetween(a,b){ return +(a + Math.random()*(b-a)).toFixed(3); }
function cryptoRandomId(){ return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2); }

/* ------------------- health & insights ------------------- */
function computeIssuerHealth(receipts){
  const byIssuer = {};
  for(const r of receipts){
    const iss = r.issuer || 'unknown';
    (byIssuer[iss] ||= []).push(r);
  }
  const rows = [];
  for(const [issuer, list] of Object.entries(byIssuer)){
    const greens = list.filter(r=>/green|ok|clean/i.test(r.attrs?.status||r.status)).length;
    const greenRate = list.length ? greens/list.length : 0;
    const kSeries = list.map(r=>r.signals?.kappa).filter(Number.isFinite);
    const dSeries = list.map(r=>r.signals?.dhol).filter(Number.isFinite);
    const pSeries = list.map(r=>r.signals?.phi_star).filter(Number.isFinite);
    const k95 = p95(kSeries);
    const dTrend = clamp01(trend(dSeries)); // crude normalization on small ranges
    const pFloor = Math.min(...pSeries, 0) || 0;

    const health = Math.round(
      100 * ( 0.5*greenRate + 0.2*(1 - clamp01(k95)) + 0.2*(1 - clamp01(dTrend)) + 0.1*clamp01(pFloor) )
    );
    rows.push({issuer, health, greenRate, k95, dTrend, pFloor});
  }
  rows.sort((a,b)=>b.health-a.health);
  return rows;
}

function insightsFrom(rows){
  if(!rows.length) return ['No data yet. Add receipts.'];

  const out=[];
  for(const r of rows){
    if (r.k95 >= 0.95 || r.pFloor < 0.15){
      out.push(`ðŸ”´ BRAKE â€” ${r.issuer}: Îº p95 ${r.k95.toFixed(3)}${r.pFloor<0.15?`, Î¦* floor ${r.pFloor.toFixed(3)}`:''}. Slow deploys, inspect last 10 reds.`);
      continue;
    }
    if (r.dTrend >= 0.15 || r.greenRate < 0.60){
      out.push(`ðŸŸ¡ WATCH â€” ${r.issuer}: drift trending up (${r.dTrend.toFixed(3)}) or green low (${fmtPct(r.greenRate)}). Add guard-rails & sample prompts.`);
      continue;
    }
    if (r.greenRate >= 0.85 && r.k95 < 0.60){
      out.push(`ðŸŸ¢ GO â€” ${r.issuer}: stable (green ${fmtPct(r.greenRate)}, Îº p95 ${r.k95.toFixed(3)}). Safe to scale traffic.`);
      continue;
    }
  }
  // pick top 3 signals
  return out.slice(0,3);
}

/* ------------------- render ------------------- */
const issuerBody = document.querySelector('#issuerTbl tbody');
const rcpBody    = document.querySelector('#rcpTbl tbody');
const packStats  = document.getElementById('packStats');
const insightsEl = document.getElementById('insights');

function renderAll(){
  // receipts table
  rcpBody.innerHTML = '';
  for(const r of RECEIPTS.slice(-300).reverse()){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="ellipsis">${r.issued_at.replace('T',' ').replace('Z','')}</td>
      <td class="ellipsis">${r.issuer||'unknown'}</td>
      <td class="ellipsis">${r.model||'â€”'}</td>
      <td class="ellipsis"><span class="badge ${asBadge(r.attrs?.status||r.status)}">${r.attrs?.status||r.status||'â€”'}</span></td>
      <td class="num">${fmt3(r.signals?.kappa)}</td>
      <td class="num">${fmt3(r.signals?.dhol)}</td>
      <td class="num">${fmt3(r.signals?.phi_star)}</td>
    `;
    rcpBody.appendChild(tr);
  }

  // issuer health
  const rows = computeIssuerHealth(RECEIPTS);
  issuerBody.innerHTML = '';
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="ellipsis">${r.issuer}</td>
      <td class="num">${r.health}</td>
      <td class="num">${fmtPct(r.greenRate)}</td>
      <td class="num">${fmt3(r.k95)}</td>
      <td class="num">${fmt3(r.dTrend)}</td>
      <td class="num">${fmt3(r.pFloor)}</td>
    `;
    issuerBody.appendChild(tr);
  }

  // stats + insights
  const greens = RECEIPTS.filter(r=>/green|ok|clean/i.test(r.attrs?.status||r.status)).length;
  packStats.textContent = RECEIPTS.length
    ? `Items: ${RECEIPTS.length} Â· GREEN: ${(greens/Math.max(1,RECEIPTS.length)*100|0)}%`
    : 'No items yet. Add Random to start.';
  const insightLines = insightsFrom(rows);
  insightsEl.innerHTML = insightLines.map(x=>`<div>${x}</div>`).join('');
}

/* ------------------- actions ------------------- */
document.getElementById('addRand').onclick  = ()=>{ RECEIPTS.push(makeRandomReceipt()); renderAll(); };
document.getElementById('addRand5').onclick = ()=>{ for(let i=0;i<5;i++) RECEIPTS.push(makeRandomReceipt()); renderAll(); };
document.getElementById('clearAll').onclick = ()=>{ if(confirm('Clear all receipts?')){ RECEIPTS.length=0; renderAll(); } };
document.getElementById('exportJsonl').onclick = ()=>{
  const lines = RECEIPTS.map(r=>JSON.stringify(r));
  const blob = new Blob([lines.join('\n')], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'receipts.jsonl';
  a.click();
  URL.revokeObjectURL(a.href);
};

/* seed a little so itâ€™s not empty */
for(let i=0;i<24;i++) RECEIPTS.push(makeRandomReceipt());
renderAll();
</script>
</body>
</html>
