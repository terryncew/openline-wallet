<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Wallet · Portable Proof</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="OpenLine Wallet">
<meta name="theme-color" content="#0a0c10">
<style>
  :root{--bg:#0a0c10;--ink:#e7ecf4;--muted:#97a3b6;--line:#1b2230;--tile:#0f141c;--btn:#1e293b;--btnink:#e7ecf4;--btnline:#2a3a55;--chip:#121925;--chipline:#1b2536;--ok:#1ea672;--warn:#b38b10;--bad:#d23d3d}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:2px 0 0} .sub{color:var(--muted);font-size:13px}
  .section{margin:18px 0} h2{font-size:16px;margin:0 0 8px}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:12px;padding:12px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--btnline);background:var(--btn);color:var(--btnink);font-weight:600}
  .chip{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--chipline);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;height:26px}
  .ok{background:rgba(30,166,114,.15);border-color:rgba(30,166,114,.35)} .warn{background:rgba(179,139,16,.15);border-color:rgba(179,139,16,.35)} .bad{background:rgba(210,61,61,.15);border-color:rgba(210,61,61,.35)} .neutral{opacity:.85}
  .note{color:var(--muted);font-size:12px;margin:8px 2px}
  input,textarea{width:100%;background:var(--tile);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
  textarea{min-height:84px;resize:vertical}
  table{width:100%;border-collapse:collapse} th,td{border-top:1px solid var(--line);padding:8px 6px;text-align:left} th{color:var(--muted);font-weight:600}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  @media (max-width:560px){ .hide-sm{display:none} }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <h1>OpenLine Wallet</h1>
      <div class="sub">Verify · Store · Explain — all local</div>
    </div>
    <div class="inline">
      <a class="btn" id="installBtn" href="#">Install</a>
      <a class="btn" id="offlineBtn" href="#">Offline ready?</a>
    </div>
  </header>

  <div class="section tile">
    <div class="inline">
      <input id="urlBox" placeholder="Paste receipt URL (raw GitHub works) or drop a .json file below">
      <a class="btn" id="addUrlBtn">Add URL</a>
      <a class="btn" id="addPasteBtn">Add JSON (from box below)</a>
      <a class="btn" id="seedBtn">Seed from manifest</a>
      <a class="btn" id="rand1">Add Random</a>
      <a class="btn" id="rand5">Add 5 Random</a>
    </div>
    <textarea id="pasteBox" class="mono" placeholder='Paste a single receipt JSON here...'></textarea>
    <div class="note">Tip: <span class="mono">?u=&lt;url&gt;</span> auto-imports on open. Drag a JSON file anywhere on this page to ingest.</div>
  </div>

  <div class="section">
    <h2>Issuer health</h2>
    <div class="tile">
      <div class="note">Score = 100×(0.5·green + 0.2·(1−κ_p95) + 0.2·(1−Δhol_trend) + 0.1·Φ*_floor). Window: last 7 days.</div>
      <div id="health"></div>
    </div>
  </div>

  <div class="section">
    <h2>Receipts</h2>
    <div class="inline" style="margin-bottom:8px">
      <a class="btn" id="exportBtn">Export JSONL</a>
      <a class="btn" id="clearBtn">Clear all</a>
      <label class="inline" style="gap:6px"><input type="checkbox" id="verifyToggle"> <span>Enable Ed25519 verify (beta)</span></label>
    </div>
    <div id="list" class="grid"></div>
  </div>

  <div class="section tile">
    <div class="note">All data stays on-device (IndexedDB). No servers. Works offline after first load.</div>
  </div>

</div>

<script>
/* ---------- tiny utils ---------- */
const $, $$ = (q,all)=> all?document.querySelectorAll(q):document.querySelector(q);
const bytelength = s => new TextEncoder().encode(s).length;
function toRaw(u){try{const url=new URL(u.trim()); if(url.hostname==='github.com'){const p=url.pathname.split('/').filter(Boolean); if(p[2]==='blob') return `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join('/')}`;} return u;}catch{return u}}
const STATUS_GREEN = s => /^(green|clean|ok|coherent)$/i.test(String(s||''));
const clamp01 = v => Math.max(0, Math.min(1, v));
const p95 = arr => { if(!arr.length) return 0; const a=[...arr].sort((a,b)=>a-b); const i=Math.floor(0.95*(a.length-1)); return a[i]; };
const mean = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;

/* ---------- IDB (no libraries) ---------- */
const DB_NAME='olw-db', STORE='receipts';
let db;
function idbOpen(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = e=>{
      const d=e.target.result;
      const s=d.createObjectStore(STORE,{keyPath:'rid'});
      s.createIndex('issued_at','issued_at'); s.createIndex('issuer_id','issuer_id'); s.createIndex('badge','badge');
    };
    req.onsuccess = ()=>{db=req.result; res(db)};
    req.onerror = ()=>rej(req.error);
  });
}
async function idbPut(obj){ await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(obj); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); })}
async function idbAll(){ await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=()=>rej(req.error); });}
async function idbClear(){ await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear(); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}

/* ---------- normalizer & checks ---------- */
function normalize(r){
  const v = r.version || r.receipt_version || r.receiptVersion || r.sku || '—';
  const status = (r.attrs?.status || r.status || '').toString();
  const model = r.model?.family || r.model?.name || r.model?.id || r.model || '—';
  const issued = r.issued_at || r.issued || r.run?.ts || r.time || r.date || new Date().toISOString();
  const issuer = r.issuer_id || r.issuer?.id || r.org?.id || model || 'default';
  const kappa = r.signals?.kappa ?? r.kappa ?? r.κ ?? r.dials?.kappa ?? null;
  const dhol  = r.signals?.dhol  ?? r.signals?.delta_hol ?? r.delta_hol ?? r.Δhol ?? r.dials?.delta_hol ?? null;
  const phi   = r.signals?.phi_star ?? r.phi_star ?? r.dials?.phi_star ?? null;
  const badge = (r.attrs?.status || r.status || '').toString().toLowerCase().includes('red') ? 'red'
              : (r.attrs?.status || r.status || '').toString().toLowerCase().match(/(amber|warn|check)/) ? 'amber' : 'green';
  const ctr = r.ctr ?? r.run?.ctr ?? null;
  const prev = r.prev ?? r.run?.prev ?? null;
  return {version:v,status,model,issued,issuer,kappa,dhol,phi,badge,ctr,prev};
}
function checkCaps(rec, bytes){
  const cleanish = /^(clean|coherent|ok|green)$/i.test(rec.status||'');
  const warnish  = /^(amber|warn|check|red|risk|bad)$/i.test(rec.status||'');
  const errs=[];
  if (!rec.status) errs.push('missing status');
  if (cleanish && bytes>640) errs.push(`CLEAN exceeds 640B (${bytes})`);
  if (warnish && bytes>800) errs.push(`${rec.status} exceeds 800B (${bytes})`);
  return {ok:errs.length===0, errs};
}
function hashPrevPayload(obj){
  // lightweight hash (not crypto) for chain demo; replace with true blake3/sha256 later
  const s = JSON.stringify(obj);
  let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return 'h'+(h>>>0).toString(16);
}

/* ---------- verify (lazy Ed25519) ---------- */
let noble = null;
async function ensureEd25519(){ if (noble) return noble; noble = await import('https://cdn.jsdelivr.net/npm/@noble/ed25519@2.1.0/esm/index.js'); return noble; }
async function verifyIfPresent(r){
  // Expect r.sig (base64), r.pub (base64), and r.payload (string) OR JCS canonical JSON in r.jcs
  if (!$('#verifyToggle').checked) return {verified:false, reason:'verify disabled'};
  if (!(r.sig && r.pub && (r.payload || r.jcs))) return {verified:false, reason:'no signature fields'};
  const ed = await ensureEd25519();
  try{
    const sig = Uint8Array.from(atob(r.sig),c=>c.charCodeAt(0));
    const pub = Uint8Array.from(atob(r.pub),c=>c.charCodeAt(0));
    const data = new TextEncoder().encode(r.payload || r.jcs);
    const ok = await ed.verify(sig, data, pub);
    return {verified:!!ok, reason: ok?'ok':'bad signature'};
  }catch(e){ return {verified:false, reason:'verify error'}; }
}

/* ---------- renderer ---------- */
function chip(txt, cls='neutral'){ const s=document.createElement('span'); s.className='chip '+cls; s.textContent=txt; return s; }
function tileFor(item){
  const t=document.createElement('div'); t.className='tile';
  const top=document.createElement('div'); top.className='inline'; top.style.justifyContent='space-between'; top.style.alignItems='center';
  const left=document.createElement('div'); left.textContent=item.title || item.url || '(local)';
  const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
  right.appendChild(chip(item.badge, item.badge==='green'?'ok':item.badge==='amber'?'warn':'bad'));
  right.appendChild(chip(item.version||'—'));
  right.appendChild(chip('bytes '+(item.bytes??'—')));
  top.appendChild(left); top.appendChild(right); t.appendChild(top);

  const row=document.createElement('div'); row.className='inline'; row.style.gap='8px'; row.style.marginTop='8px';
  const toTxt=(k,v)=> (typeof v==='number'&&Number.isFinite(v)) ? (k==='phi'?`${v.toFixed(3)} (${Math.round(clamp01(v)*5)}★)` : v.toFixed(3)) : (v==null?'—':String(v));
  row.appendChild(chip(`κ ${toTxt('k', item.kappa)}`));
  row.appendChild(chip(`Δhol ${toTxt('d', item.dhol)}`));
  row.appendChild(chip(`Φ* ${toTxt('phi', item.phi)}`));
  t.appendChild(row);

  const meta=document.createElement('div'); meta.className='note mono';
  meta.textContent = `issuer=${item.issuer} · model=${item.model||'—'} · issued=${item.issued}`;
  t.appendChild(meta);

  const btns=document.createElement('div'); btns.className='inline'; btns.style.marginTop='8px';
  if (item.url){ const open=document.createElement('a'); open.className='btn'; open.textContent='Open'; open.href=item.url; open.target='_blank'; btns.appendChild(open); }
  const rm=document.createElement('a'); rm.className='btn'; rm.textContent='Remove'; rm.href='#';
  rm.onclick=(e)=>{e.preventDefault(); removeReceipt(item.rid);};
  btns.appendChild(rm);
  t.appendChild(btns);
  return t;
}
function renderList(items){
  const list=$('#list'); list.innerHTML='';
  items.sort((a,b)=> (b.issued||'').localeCompare(a.issued||''));
  items.forEach(it=> list.appendChild(tileFor(it)));
}
function renderHealth(items){
  const byIssuer = {};
  items.forEach(it=>{ (byIssuer[it.issuer] ||= []).push(it); });
  const table=document.createElement('table');
  table.innerHTML = `<thead><tr>
    <th>Issuer</th><th>Score</th><th class="hide-sm">Green rate</th><th>κ p95</th><th class="hide-sm">Δhol avg</th><th class="hide-sm">Φ* floor</th><th class="hide-sm">N</th>
  </tr></thead>`;
  const tb=document.createElement('tbody');
  const now=Date.now(), win=7*24*3600*1000;
  Object.entries(byIssuer).forEach(([issuer,arr])=>{
    const w = arr.filter(x => (new Date(x.issued)).getTime() > (now-win));
    const n = w.length || arr.length;
    const use = w.length? w : arr;
    const green = use.filter(x=>x.badge==='green').length / (use.length||1);
    const kappas = use.map(x=>Number(x.kappa)).filter(Number.isFinite);
    const dhols  = use.map(x=>Number(x.dhol)).filter(Number.isFinite);
    const phis   = use.map(x=>Number(x.phi)).filter(Number.isFinite);
    const k95 = kappas.length ? p95(kappas) : 0;
    const dAvg = dhols.length ? mean(dhols) : 0;
    const phiFloor = phis.length ? Math.min(...phis) : 0;
    const score = 100*(0.5*green + 0.2*(1-k95) + 0.2*(1-dAvg) + 0.1*phiFloor);
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${issuer}</td>
      <td><b>${Math.max(0,Math.min(100,score)).toFixed(0)}</b></td>
      <td class="hide-sm">${(green*100).toFixed(0)}%</td>
      <td>${k95.toFixed(3)}</td>
      <td class="hide-sm">${dAvg.toFixed(3)}</td>
      <td class="hide-sm">${phiFloor.toFixed(3)}</td>
      <td class="hide-sm">${n}</td>`;
    tb.appendChild(tr);
  });
  table.appendChild(tb);
  $('#health').innerHTML=''; $('#health').appendChild(table);
}

/* ---------- ingest ---------- */
async function addReceiptFromUrl(u){
  const raw=toRaw(u); const res=await fetch(raw,{cache:'no-store'}); if(!res.ok) throw new Error('fetch failed '+res.status);
  const txt=await res.text(); const j=JSON.parse(txt);
  await addReceiptCore(j, {url:raw, bytes:bytelength(txt)});
}
async function addReceiptFromText(txt){
  const j=JSON.parse(txt); await addReceiptCore(j, {url:null, bytes:bytelength(JSON.stringify(j))});
}
async function addReceiptCore(j, meta){
  const n = normalize(j);
  const caps = checkCaps(n, meta.bytes);
  const chain_ok = (n.ctr==null && n.prev==null) ? true : (typeof n.ctr==='number' && typeof n.prev==='string');
  const sig = await verifyIfPresent(j);
  const rid = j.rid || j.id || (n.issuer + ':' + (n.ctr??'x') + ':' + hashPrevPayload(j).slice(-6) + ':' + Math.random().toString(36).slice(2,8));
  const rec = {
    rid, issuer:n.issuer, model:n.model, version:n.version, issued:n.issued,
    kappa: Number(n.kappa), dhol: Number(n.dhol), phi: Number(n.phi),
    badge: (n.badge || (STATUS_GREEN(n.status)?'green':(String(n.status||'').match(/(amber|warn|check)/)?'amber':'red'))),
    bytes: meta.bytes, url: meta.url, caps_ok:caps.ok, chain_ok, verified: sig.verified
  };
  await idbPut(rec);
  const items = await idbAll(); renderList(items); renderHealth(items);
}
async function removeReceipt(rid){
  await idbOpen();
  await new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(rid); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });
  const items=await idbAll(); renderList(items); renderHealth(items);
}

/* ---------- seeders ---------- */
async function seedFromManifest(){
  // tries local repo first
  const paths=['receipts/manifest.json','docs/receipts/manifest.json'];
  for (const p of paths){
    try{ const r=await fetch(p+'?v='+Date.now(),{cache:'no-store'}); if(!r.ok) continue; const list=await r.json();
      const arr=Array.isArray(list)?list:(list.files||list.receipts||list.items||[]);
      for (const u of arr){ try{ await addReceiptFromUrl(u); }catch{} }
      return true;
    }catch{}
  }
  alert('No manifest found in this repo.');
  return false;
}
function randomReceipt(){
  const now=new Date().toISOString();
  const bucket=Math.random(); let status, kR, dR, pR;
  if (bucket<0.6){ status='CLEAN'; kR=[0.05,0.50]; dR=[0.00,0.30]; pR=[0.80,0.98]; }
  else if (bucket<0.9){ status='AMBER'; kR=[0.50,0.90]; dR=[0.30,0.60]; pR=[0.45,0.80]; }
  else { status='RED'; kR=[0.90,1.20]; dR=[0.60,1.00]; pR=[0.10,0.45]; }
  const pick=a=>a[Math.floor(Math.random()*a.length)];
  const rec = {
    receipt_version:"1.5-P", version:"OLR/1.5-P", issued_at: now,
    issuer_id: pick(['agent-alpha','agent-beta','service-x','service-y']),
    attrs:{status}, model:{family: pick(['demo-llm','op-llm','agent-x'])},
    precision:{train_dtype:"fp16", infer_dtype:"fp16"},
    signals:{ kappa:+(kR[0]+Math.random()*(kR[1]-kR[0])).toFixed(3),
              dhol:+(dR[0]+Math.random()*(dR[1]-dR[0])).toFixed(3),
              phi_star:+(pR[0]+Math.random()*(pR[1]-pR[0])).toFixed(3) }
  };
  return rec;
}

/* ---------- export ---------- */
async function exportJSONL(){
  const items=await idbAll();
  const lines = items.map(x=>JSON.stringify(x)).join('\n');
  const blob=new Blob([lines],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='receipts.jsonl'; a.click(); URL.revokeObjectURL(url);
}

/* ---------- boot ---------- */
async function boot(){
  await idbOpen();
  const u=new URL(location.href).searchParams.get('u'); if(u){ try{ await addReceiptFromUrl(u); }catch{} }
  renderList(await idbAll()); renderHealth(await idbAll());
  if ('serviceWorker' in navigator){ try{ await navigator.serviceWorker.register('./sw.js'); }catch{} }
}
boot();

/* ---------- wire up ---------- */
$('#addUrlBtn').onclick = async ()=>{ const u=$('#urlBox').value.trim(); if(!u) return; try{ await addReceiptFromUrl(u); $('#urlBox').value=''; }catch(e){ alert('Add failed'); } };
$('#addPasteBtn').onclick = async ()=>{ const t=$('#pasteBox').value.trim(); if(!t) return; try{ await addReceiptFromText(t); $('#pasteBox').value=''; }catch(e){ alert('Bad JSON'); } };
$('#seedBtn').onclick = ()=> seedFromManifest();
$('#rand1').onclick = async ()=>{ await addReceiptCore(randomReceipt(), {url:null, bytes:0}); };
$('#rand5').onclick = async ()=>{ for(let i=0;i<5;i++) await addReceiptCore(randomReceipt(), {url:null, bytes:0}); };
$('#exportBtn').onclick = exportJSONL;
$('#clearBtn').onclick = async ()=>{ if(!confirm('Clear all receipts?')) return; await idbClear(); renderList([]); renderHealth([]); };
$('#offlineBtn').onclick = ()=> navigator.serviceWorker?.controller ? alert('Offline ready ✅') : alert('Not cached yet — reload once');
let deferredPrompt=null; window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault(); deferredPrompt=e;});
$('#installBtn').onclick = async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; } else alert('Use “Add to Home Screen” in Safari share sheet'); };

// drag & drop
document.addEventListener('dragover', e=>{ e.preventDefault(); });
document.addEventListener('drop', async e=>{
  e.preventDefault();
  const f=[...(e.dataTransfer?.files||[])].find(x=>x.type==='application/json' || x.name.endsWith('.json'));
  if (!f) return;
  const txt=await f.text(); await addReceiptFromText(txt);
});
</script>
</body>
</html>
