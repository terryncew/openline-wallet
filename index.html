<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>OpenLine Wallet · Mobile</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0a0c10; --ink:#e7ecf4; --muted:#97a3b6;
    --line:#1b2230; --tile:#0f141c;
    --ok:#1ea672; --warn:#b38b10; --bad:#d23d3d;
    --chip:#121925; --chipline:#1b2536;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial}
  .wrap{max-width:680px;margin:0 auto;padding:16px;padding-bottom:calc(16px + env(safe-area-inset-bottom,0))}
  h1{font-size:20px;margin:0 0 6px}
  .sub{color:var(--muted);font-size:13px}
  .section{margin:14px 0}
  .tile{background:var(--tile);border:1px solid var(--line);border-radius:14px;padding:12px;overflow:hidden}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid #2a3a55;background:#182234;color:var(--ink);font-weight:600}
  .note{color:var(--muted);font-size:12px;margin:6px 2px}
  .mono{font-variant-numeric:tabular-nums}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px}
  .kpi{background:var(--chip);border:1px solid var(--chipline);border-radius:10px;padding:6px 8px}
  .kpi .lab{color:var(--muted);font-size:11px}
  .kpi .val{font-weight:600}
  .action{padding:4px 10px;border-radius:999px;border:1px solid var(--chipline);font-size:12px}
  .act-go{background:rgba(30,166,114,.15)}
  .act-watch{background:rgba(179,139,16,.15)}
  .act-brake{background:rgba(210,61,61,.15)}
  /* compact issuer list */
  .issuer{border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
  .insight{margin-top:6px;font-size:13px}
  /* receipts list contained inside the tile */
  .list{max-height:360px;overflow:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--line);border-radius:12px}
  .item{display:grid;grid-template-columns:1.2fr .8fr .8fr auto;gap:8px;padding:10px 12px;border-top:1px solid var(--line)}
  .item:first-child{border-top:0}
  .badge{justify-self:end;align-self:center;padding:4px 10px;border-radius:999px;border:1px solid var(--chipline);font-size:12px}
  .b-ok{background:rgba(30,166,114,.15)}
  .b-warn{background:rgba(179,139,16,.15)}
  .b-bad{background:rgba(210,61,61,.15)}
  /* keep everything inside the rounded tile on tiny screens */
  @media (max-width:420px){
    .item{grid-template-columns:1fr .8fr auto}
    .hide-xs{display:none}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="section">
    <h1>OpenLine Wallet</h1>
    <div class="sub">Mobile-first • everything fits inside the tile • opinionated analytics</div>
  </div>

  <!-- Controls -->
  <div class="section tile">
    <div class="row">
      <div class="sub" id="stats">—</div>
      <div>
        <a class="btn" id="add5">+5</a>
        <a class="btn" id="add20">+20</a>
        <a class="btn" id="clr">Clear</a>
      </div>
    </div>
  </div>

  <!-- Issuer health (compact) -->
  <div class="section tile">
    <div class="row">
      <div style="font-weight:700">Issuer health</div>
      <div class="sub">Last 7 days</div>
    </div>
    <div id="issuers"></div>
  </div>

  <!-- Receipts (contained) -->
  <div class="section tile">
    <div class="row">
      <div style="font-weight:700">Receipts</div>
      <div class="sub">Newest first</div>
    </div>
    <div class="list" id="list"></div>
  </div>

  <div class="section sub">OpenLine · COLE · MIT.</div>
</div>

<script>
/* ===== utilities ===== */
const clamp01=v=>Math.max(0,Math.min(1,v));
const avg=a=>a.length?a.reduce((x,y)=>x+y,0)/a.length:0;
const p95=a=>{if(!a.length)return 0;const s=[...a].sort((x,y)=>x-y);const i=Math.min(s.length-1,Math.floor(0.95*(s.length-1)));return s[i];};
const trend=v=>{const n=v.length;if(n<2)return 0;const mx=avg(v),mt=(n-1)/2;let num=0,den=0;for(let t=0;t<n;t++){num+=(t-mt)*(v[t]-mx);den+=(t-mt)*(t-mt);}return den?num/den:0;};
const fmt3=x=>Number.isFinite(x)?x.toFixed(3):'0.000';
const pct=x=>(x*100).toFixed(1)+'%';
const asBadge = s => s.match(/green|ok|clean/i) ? 'ok' : s.match(/amber|warn|check/i) ? 'warn' : 'bad';

/* ===== demo data ===== */
let RECEIPTS=[];
function rid(){return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);}
function pick(a){return a[Math.floor(Math.random()*a.length)];}
function rb(a,b){return +(a+Math.random()*(b-a)).toFixed(3);}
function sample(){
  const now = new Date().toISOString();
  const issuer = pick(['labA','labB','opsX']);
  const model = pick(['agent-x','op-llm','demo-llm']);
  const r = Math.random();
  let badge,k,d,p;
  if(r<0.6){badge='GREEN';k=rb(0.05,0.55);d=rb(0.00,0.30);p=rb(0.80,0.98);}
  else if(r<0.9){badge='AMBER';k=rb(0.55,0.90);d=rb(0.30,0.60);p=rb(0.45,0.80);}
  else{badge='RED';k=rb(0.90,1.20);d=rb(0.60,1.00);p=rb(0.10,0.45);}
  return {rid:rid(),issued_at:now,issuer,model,attrs:{status:badge},signals:{kappa:k,dhol:d,phi_star:p}};
}

/* ===== health + insight ===== */
function groupByIssuer(list){
  const m={}; for(const r of list){(m[r.issuer||'unknown']??=[]).push(r);} return m;
}
function computeHealth(list){
  const out=[];
  const by = groupByIssuer(list);
  for(const [issuer,rows] of Object.entries(by)){
    const n = rows.length;
    const green = rows.filter(r=>/green|ok|clean/i.test(r.attrs?.status||r.status)).length/n || 0;
    const ks = rows.map(r=>r.signals?.kappa).filter(Number.isFinite);
    const ds = rows.map(r=>r.signals?.dhol).filter(Number.isFinite);
    const ps = rows.map(r=>r.signals?.phi_star).filter(Number.isFinite);
    const k95 = clamp01(p95(ks));
    const dTrend = clamp01(trend(ds));
    const pFloor = clamp01(Math.min(...ps,
